OCaml Bitset shootout
---------------------

### Contestants

  - [Zarith](https://github.com/ocaml/zarith)
  - [Batteries BitSet](https://github.com/ocaml-batteries-team/batteries-included/blob/master/src/batBitSet.ml), Pure
  - [Bit vector](https://github.com/backtracking/bitv), Pure
  - [Bitarray](https://github.com/travisbrady/ocaml-bitarray)  Unreleased, Ctypes bindings
  - [Ocbitset](https://github.com/rleonid/ocbitset) Unreleased, Another Ctypes bindings

### Setup

Given a universe of 4000 elements, we test
[bitsets, bitvectors, bitarrays](https://en.wikipedia.org/wiki/Bit_array) operations.

### Creation

Time necessary to create an element with `n` bits set.

| Name            | Runs @ Samples | Time R^2 | Time/Run |              95ci | Cycls/Run |     mWd/Run | mjWd/Run | Prom/Run |   mGC/Run | mjGC/Run | Percentage |
|----------------:|---------------:|---------:|---------:|------------------:|----------:|------------:|---------:|---------:|----------:|---------:|-----------:|
| Zarith:10       |    48289 @ 778 |     0.87 |   2.14us |   -0.15us +0.19us |    6.42kc |     865.00w |    0.11w |    0.11w |   3.30e-3 |          |      0.72% |
| Zarith:100      |     3645 @ 517 |     0.74 |  24.77us |   -1.08us +1.31us |   74.29kc |  10_001.00w |    3.46w |    3.46w |  38.16e-3 |  0.01e-3 |      8.28% |
| Zarith:1000     |      327 @ 259 |     0.54 | 299.23us | -31.12us +38.71us |  897.64kc | 100_341.00w |   36.91w |   36.91w | 382.87e-3 |  0.13e-3 |    100.00% |
| Batteries:10    |    57179 @ 795 |     0.88 |   1.85us |   -0.12us +0.13us |    5.55kc |     197.00w |          |          |   0.75e-3 |          |      0.62% |
| Batteries:100   |     5963 @ 567 |     0.98 |  15.92us |   -0.17us +0.23us |   47.77kc |     865.00w |    0.45w |    0.45w |   3.30e-3 |          |      5.32% |
| Batteries:1000  |      562 @ 321 |     0.97 | 162.23us |   -2.15us +3.05us |  486.68kc |   5_509.19w |    2.86w |    2.86w |  21.01e-3 |          |     54.22% |
| Bitv:10         |    63786 @ 806 |     0.91 |   1.68us |   -0.10us +0.10us |    5.04kc |     105.00w |          |          |   0.40e-3 |          |      0.56% |
| Bitv:100        |     5963 @ 567 |     0.96 |  16.35us |   -0.38us +0.43us |   49.04kc |     375.01w |          |          |   1.43e-3 |          |      5.46% |
| Bitv:1000       |      567 @ 322 |     0.99 | 160.43us |   -1.22us +1.34us |  481.28kc |   3_075.07w |    0.89w |    0.89w |  11.74e-3 |          |     53.62% |
| Bitarray:10     |    34445 @ 744 |     0.71 |   3.22us |   -0.39us +0.45us |    9.66kc |     102.35w |   16.02w |   16.02w |   0.40e-3 |  0.02e-3 |      1.08% |
| Bitarray:100    |     5297 @ 555 |     0.98 |  17.68us |   -0.20us +0.25us |   53.04kc |     372.75w |   16.01w |   16.01w |   1.43e-3 |  0.02e-3 |      5.91% |
| Bitarray:1000   |      482 @ 304 |     0.72 | 192.28us | -10.45us +12.29us |  576.81kc |   3_062.69w |   16.28w |   16.28w |  11.70e-3 |  0.04e-3 |     64.26% |
| Ocbitset:10     |    36199 @ 749 |     0.75 |   2.62us |   -0.16us +0.18us |    7.87kc |      50.00w |   11.01w |   11.01w |   0.20e-3 |  0.01e-3 |      0.88% |
| Ocbitset:100    |     5297 @ 555 |     0.94 |  18.67us |   -0.68us +0.84us |   55.99kc |     320.00w |   11.03w |   11.03w |   1.23e-3 |  0.02e-3 |      6.24% |
| Ocbitset:1000   |      527 @ 314 |     0.99 | 170.93us |   -0.93us +1.20us |  512.77kc |   3_020.00w |   11.13w |   11.13w |  11.54e-3 |  0.02e-3 |     57.12% |
| Containers:10   |    60093 @ 800 |     0.89 |   1.75us |   -0.11us +0.11us |    5.24kc |     146.00w |          |          |   0.56e-3 |          |      0.58% |
| Containers:100  |     5789 @ 564 |     0.95 |  16.61us |   -0.48us +0.52us |   49.81kc |     233.00w |    0.11w |    0.11w |   0.89e-3 |          |      5.55% |
| Containers:1000 |      486 @ 305 |     0.86 | 190.82us |   -7.69us +8.45us |  572.42kc |     246.00w |    0.14w |    0.14w |   0.95e-3 |          |     63.77% |

Zarith suffers because we have to `shift_one` to create the appropriate value
to `logor` with. The confidence intervals underestimate the true values. And
in general, the times are only for relative comparison.

### Union

Time necessary to compute `n` unions of bitsets with 2000 (half) elements.

| Name            | Runs @ Samples | Time R^2 |       Time/Run |                       95ci |  Cycls/Run |    mWd/Run |   mjWd/Run |   Prom/Run |   mGC/Run | mjGC/Run | Percentage |
|----------------:|---------------:|---------:|---------------:|---------------------------:|-----------:|-----------:|-----------:|-----------:|----------:|---------:|-----------:|
| Zarith:10       |   249172 @ 943 |     0.92 |       411.57ns |          -20.09ns +25.64ns |     1.23kc |    601.00w |      0.15w |      0.15w |   2.29e-3 |          |      0.03% |
| Zarith:100      |    18612 @ 682 |     0.77 |     5_585.74ns |        -479.64ns +575.25ns |    16.76kc |  6_541.00w |      1.81w |      1.81w |  24.96e-3 |          |      0.35% |
| Zarith:1000     |     1771 @ 443 |     0.87 |    54_359.25ns |    -2_347.06ns +4_186.21ns |   163.07kc | 65_941.00w |     18.35w |     18.35w | 251.58e-3 |  0.04e-3 |      3.40% |
| Batteries:10    |     7709 @ 593 |     0.99 |    12_116.03ns |        -131.68ns +156.37ns |    36.35kc |    601.00w |      0.15w |      0.15w |   2.29e-3 |          |      0.76% |
| Batteries:100   |      680 @ 342 |     0.99 |   134_414.68ns |    -1_179.74ns +1_234.30ns |   403.22kc |  6_541.00w |      1.77w |      1.77w |  24.95e-3 |          |      8.41% |
| Batteries:1000  |      119 @ 119 |     0.93 | 1_445_474.87ns |  -52_088.28ns +58_766.39ns | 4_336.23kc | 65_941.00w |     17.87w |     17.87w | 251.60e-3 |          |     90.46% |
| Bitvector:10    |    57750 @ 796 |     0.74 |     1_972.27ns |        -224.38ns +265.07ns |     5.92kc |    628.00w |      0.12w |      0.12w |   2.40e-3 |          |      0.12% |
| Bitvector:100   |     5194 @ 553 |     0.89 |    18_624.30ns |      -863.22ns +1_016.37ns |    55.87kc |  6_838.00w |      1.89w |      1.89w |  26.09e-3 |          |      1.17% |
| Bitvector:1000  |      438 @ 293 |     0.56 |   189_218.07ns |    -6_615.51ns +7_956.12ns |   567.62kc | 68_938.00w |     19.19w |     19.19w | 263.06e-3 |  0.05e-3 |     11.84% |
| Bitarray:10     |     7709 @ 593 |     0.79 |    13_642.24ns |      -996.41ns +1_154.31ns |    40.92kc |    709.87w |    144.17w |    144.17w |   2.76e-3 |  0.11e-3 |      0.85% |
| Bitarray:100    |      620 @ 332 |     0.72 |   139_013.10ns |    -4_965.29ns +5_156.80ns |   417.01kc |  7_758.49w |  1_586.99w |  1_586.99w |  30.14e-3 |  1.27e-3 |      8.70% |
| Bitarray:1000   |      115 @ 115 |     0.84 | 1_597_953.56ns | -95_249.14ns +107_253.38ns | 4_793.62kc | 78_269.53w | 16_000.17w | 16_000.17w | 304.07e-3 | 13.80e-3 |    100.00% |
| Ocbitset:10     |     8181 @ 599 |     0.49 |    11_524.71ns |    -1_372.41ns +1_434.37ns |    34.57kc |    106.00w |     98.89w |     98.89w |   0.43e-3 |  0.05e-3 |      0.72% |
| Ocbitset:100    |      795 @ 359 |     0.40 |   114_867.65ns |  -13_145.27ns +14_031.12ns |   344.58kc |  1_096.02w |  1_093.22w |  1_093.22w |   4.43e-3 |  0.49e-3 |      7.19% |
| Ocbitset:1000   |      138 @ 138 |     0.44 | 1_039_918.85ns | -97_239.49ns +105_218.80ns | 3_119.59kc | 10_996.16w | 11_062.50w | 11_062.50w |  44.51e-3 |  4.98e-3 |     65.08% |
| Containers:10   |    58327 @ 797 |     0.94 |     1_700.85ns |          -78.54ns +82.05ns |     5.10kc |    619.00w |      0.16w |      0.16w |   2.36e-3 |          |      0.11% |
| Containers:100  |     5963 @ 567 |     0.90 |    17_772.77ns |      -972.83ns +1_067.74ns |    53.32kc |  6_739.00w |      1.86w |      1.86w |  25.71e-3 |          |      1.11% |
| Containers:1000 |      399 @ 283 |     0.59 |   221_762.22ns |  -16_265.51ns +18_767.59ns |   665.25kc | 67_939.00w |     18.90w |     18.90w | 259.24e-3 |  0.05e-3 |     13.88% |

- The cost of jumping to C hurts the wrappers.
- An efficient logor is key.

### Diff

Time necessary to compute `n` diff of bitsets with 2000 (half) elements.

| Name            | Runs @ Samples | Time R^2 |        Time/Run |                          95ci |   Cycls/Run |     mWd/Run |   mjWd/Run |   Prom/Run |   mGC/Run | mjGC/Run | Percentage |
|----------------:|---------------:|---------:|----------------:|------------------------------:|------------:|------------:|-----------:|-----------:|----------:|---------:|-----------:|
| Zarith:10       |   108046 @ 859 |     0.98 |        922.16ns |             -24.01ns +30.53ns |      2.77kc |   1_187.00w |      0.45w |      0.45w |   4.53e-3 |          |            |
| Zarith:100      |    15724 @ 665 |     0.95 |      6_025.36ns |           -137.17ns +155.81ns |     18.08kc |   7_352.00w |      0.81w |      0.81w |  28.05e-3 |          |      0.02% |
| Zarith:1000     |     1592 @ 432 |     0.96 |     58_885.97ns |       -1_300.36ns +1_620.63ns |    176.65kc |  67_590.00w |      2.32w |      2.32w | 257.86e-3 |  0.01e-3 |      0.18% |
| Batteries:10    |     7194 @ 586 |     0.99 |     13_436.34ns |           -218.47ns +222.95ns |     40.31kc |     601.00w |      0.15w |      0.15w |   2.29e-3 |          |      0.04% |
| Batteries:100   |      614 @ 331 |     0.97 |    149_368.17ns |       -2_745.48ns +2_763.21ns |    448.08kc |   6_541.00w |      1.77w |      1.77w |  24.97e-3 |          |      0.45% |
| Batteries:1000  |      115 @ 115 |     0.94 |  1_539_559.70ns |     -41_603.58ns +47_385.03ns |  4_618.47kc |  65_941.00w |     17.87w |     17.87w | 251.66e-3 |          |      4.64% |
| Bitvector:10    |    35136 @ 746 |     0.99 |      2_769.92ns |             -41.80ns +44.93ns |      8.31kc |   1_249.01w |      0.46w |      0.46w |   4.77e-3 |          |            |
| Bitvector:100   |     3145 @ 502 |     0.99 |     30_319.71ns |           -407.37ns +448.25ns |     90.95kc |  13_669.00w |      5.57w |      5.57w |  52.16e-3 |  0.01e-3 |      0.09% |
| Bitvector:1000  |      294 @ 247 |     0.94 |    316_323.91ns |       -5_981.04ns +6_712.48ns |    948.92kc | 137_869.78w |     56.51w |     56.51w | 526.05e-3 |  0.14e-3 |      0.95% |
| Bitarray:10     |     4351 @ 535 |     0.93 |     22_348.78ns |           -603.80ns +621.72ns |     67.04kc |   1_361.74w |    288.30w |    288.30w |   5.31e-3 |  0.24e-3 |      0.07% |
| Bitarray:100    |      360 @ 270 |     0.88 |    261_662.54ns |       -8_997.15ns +8_544.25ns |    784.95kc |  14_856.55w |  3_172.75w |  3_172.75w |  57.91e-3 |  2.65e-3 |      0.79% |
| Bitarray:1000   |        88 @ 88 |     0.93 |  2_663_724.01ns |    -88_155.99ns +108_772.52ns |  7_990.78kc | 150_369.06w | 32_020.81w | 32_020.81w | 584.74e-3 | 26.78e-3 |      8.03% |
| Ocbitset:10     |    11338 @ 632 |     0.63 |      8_974.04ns |           -926.25ns +884.63ns |     26.92kc |     106.00w |     98.94w |     98.94w |   0.43e-3 |  0.05e-3 |      0.03% |
| Ocbitset:100    |      933 @ 376 |     0.47 |    100_213.96ns |     -10_521.17ns +10_970.02ns |    300.62kc |   1_096.02w |  1_088.42w |  1_088.42w |   4.42e-3 |  0.49e-3 |      0.30% |
| Ocbitset:1000   |      146 @ 146 |     0.61 |    955_862.11ns |     -75_666.05ns +70_927.04ns |  2_867.43kc |  10_996.16w | 11_056.38w | 11_056.38w |  44.46e-3 |  4.89e-3 |      2.88% |
| Containers:10   |      306 @ 252 |     0.98 |    303_547.82ns |       -4_325.55ns +4_629.42ns |    910.59kc |   1_276.01w |      0.56w |      0.56w |   4.87e-3 |          |      0.92% |
| Containers:100  |        78 @ 78 |     0.97 |  3_425_485.78ns |    -98_195.71ns +111_274.54ns | 10_276.03kc |  13_966.00w |      5.98w |      5.98w |  53.50e-3 |          |     10.33% |
| Containers:1000 â”‚        25 @ 25 |     0.98 | 33_172_413.40ns | -791_432.09ns +1_282_741.99ns | 99_513.34kc | 140_866.00w |     57.62w |     57.62w | 538.37e-3 |          |    100.00% |

- Containers requires a custom, slow, negation.
- Bitarray, also requires a negation.
- Bitv also requires a negation but achieves good performance ?

